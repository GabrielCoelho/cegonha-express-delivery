package br.com.cegonhaexpress.cegonha_express.integration;

import static org.junit.jupiter.api.Assertions.*;

import br.com.cegonhaexpress.cegonha_express.config.RestTemplateConfig;
import br.com.cegonhaexpress.cegonha_express.dto.ViaCepResponseDto;
import br.com.cegonhaexpress.cegonha_express.model.entity.Endereco;
import br.com.cegonhaexpress.cegonha_express.model.enums.UF;
import br.com.cegonhaexpress.cegonha_express.services.ViaCepService;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.springframework.web.client.RestTemplate;

/**
 * Testes de integra√ß√£o completa do sistema ViaCEP.
 *
 * <p>Testa o fluxo completo: Config ‚Üí Service ‚Üí DTO ‚Üí Entity
 *
 * @author Gabriel Coelho Soares
 */
@DisplayName("ViaCEP - Testes de Integra√ß√£o Completa")
class ViaCepIntegrationTest {

  private ViaCepService viaCepService;
  private RestTemplateConfig config;

  @BeforeEach
  void setUp() {
    System.out.println("\n=== CONFIGURANDO INTEGRA√á√ÉO COMPLETA ===");

    // Montar toda a estrutura como seria no Spring
    config = new RestTemplateConfig();
    RestTemplate restTemplate = config.createRestTemplate();
    viaCepService = new ViaCepService(restTemplate);

    System.out.println("‚úÖ Stack completa configurada:");
    System.out.println("   üìÑ RestTemplateConfig instanciado");
    System.out.println("   üåê RestTemplate configurado com timeouts");
    System.out.println("   üîß ViaCepService injetado com RestTemplate");
    System.out.println("   üöÄ Sistema pronto para testes de integra√ß√£o");
  }

  @Test
  @DisplayName("Deve executar fluxo completo de busca e convers√£o")
  void deveExecutarFluxoCompletoDeBuscaEConversao() {
    System.out.println("\nüß™ TESTE DE INTEGRA√á√ÉO: Fluxo completo");

    // Arrange
    String cepTeste = "01001-000"; // CEP da Pra√ßa da S√©, SP
    String numero = "100";
    String complemento = "Lado √≠mpar";

    System.out.println("üìã Par√¢metros do teste:");
    System.out.println("   CEP: " + cepTeste);
    System.out.println("   N√∫mero: " + numero);
    System.out.println("   Complemento: " + complemento);
    System.out.println("\nüîÑ Iniciando fluxo de integra√ß√£o...");

    try {
      // Act 1: Buscar via API
      System.out.println("\n1Ô∏è‚É£ ETAPA: Busca na API ViaCEP");
      ViaCepResponseDto response = viaCepService.buscarEnderecoPorCep(cepTeste);

      // Assert 1: Verificar resposta da API
      if (response != null && !response.isErro()) {
        System.out.println("‚úÖ API respondeu com sucesso");
        System.out.println("   üè¢ Logradouro: " + response.getLogradouro());
        System.out.println("   üèôÔ∏è Cidade: " + response.getLocalidade());
        System.out.println("   üó∫Ô∏è UF: " + response.getUf());
        System.out.println("   üìÆ CEP: " + response.getCep());

        assertNotNull(response);
        assertFalse(response.isErro());
        assertTrue(response.isCepEncontrado());

        // Act 2: Converter para Endereco
        System.out.println("\n2Ô∏è‚É£ ETAPA: Convers√£o para entidade");
        Endereco endereco = viaCepService.converterParaEndereco(response, numero, complemento);

        // Assert 2: Verificar convers√£o
        if (endereco != null) {
          System.out.println("‚úÖ Convers√£o realizada com sucesso");
          System.out.println("   üìç Endere√ßo completo: " + endereco.getEnderecoCompleto());
          System.out.println("   üÜî ID entidade: " + endereco.getId());
          System.out.println("   ‚úÖ Endere√ßo completo: " + endereco.isCompleto());

          assertNotNull(endereco);
          assertEquals(response.getCep(), endereco.getCep());
          assertEquals(response.getLogradouro(), endereco.getLogradouro());
          assertEquals(response.getLocalidade(), endereco.getCidade());
          assertEquals(numero, endereco.getNumero());
          assertEquals(UF.valueOf(response.getUf()), endereco.getUf());
          assertTrue(endereco.isCompleto());

          // Act 3: Teste do m√©todo integrado
          System.out.println("\n3Ô∏è‚É£ ETAPA: M√©todo integrado (buscar + converter)");
          Endereco enderecoIntegrado =
              viaCepService.buscarEConverterEndereco(cepTeste, numero, complemento);

          // Assert 3: Verificar m√©todo integrado
          assertNotNull(enderecoIntegrado);
          assertEquals(endereco.getCep(), enderecoIntegrado.getCep());
          assertEquals(endereco.getCidade(), enderecoIntegrado.getCidade());
          System.out.println("‚úÖ M√©todo integrado funcionando corretamente");

        } else {
          System.out.println("‚ö†Ô∏è Convers√£o retornou null - poss√≠vel problema na UF");
          fail("Convers√£o n√£o deveria retornar null para dados v√°lidos");
        }

      } else {
        System.out.println("‚ö†Ô∏è API n√£o respondeu ou retornou erro");
        System.out.println("   Isso pode acontecer por:");
        System.out.println("   - Conex√£o com internet indispon√≠vel");
        System.out.println("   - API ViaCEP temporariamente fora do ar");
        System.out.println("   - CEP realmente n√£o existente");

        // Para testes de integra√ß√£o, isso √© aceit√°vel
        System.out.println("üü° TESTE IGNORADO - Depend√™ncia externa indispon√≠vel");
        org.junit.jupiter.api.Assumptions.assumeTrue(false, "API ViaCEP indispon√≠vel");
      }

    } catch (Exception e) {
      System.out.println("‚ùå ERRO durante integra√ß√£o: " + e.getMessage());
      System.out.println("   Tipo: " + e.getClass().getSimpleName());

      // Para testes de integra√ß√£o, logging √© importante
      e.printStackTrace();

      // Decidir se falha √© aceit√°vel ou n√£o
      if (e.getMessage().contains("timeout") || e.getMessage().contains("connection")) {
        System.out.println("üü° ERRO DE REDE - Aceit√°vel em testes de integra√ß√£o");
        org.junit.jupiter.api.Assumptions.assumeTrue(false, "Erro de rede: " + e.getMessage());
      } else {
        fail("Erro inesperado na integra√ß√£o: " + e.getMessage());
      }
    }

    System.out.println("\nüéâ TESTE DE INTEGRA√á√ÉO CONCLU√çDO!");
  }

  @Test
  @DisplayName("Deve testar diferentes cen√°rios de CEP")
  void deveTestarDiferentesCenariosDeCep() {
    System.out.println("\nüß™ TESTE DE INTEGRA√á√ÉO: M√∫ltiplos CEPs");

    // CEPs de teste (reais e conhecidos)
    String[] cepsParaTeste = {
      "01001-000", // Pra√ßa da S√©, SP
      "20040-020", // Rio de Janeiro, RJ
      "70040-010", // Bras√≠lia, DF
      "80010-000", // Curitiba, PR
      "99999-999" // CEP inexistente
    };

    int sucessos = 0;
    int erros = 0;
    int timeouts = 0;

    for (String cep : cepsParaTeste) {
      System.out.println("\nüîç Testando CEP: " + cep);

      try {
        ViaCepResponseDto response = viaCepService.buscarEnderecoPorCep(cep);

        if (response == null) {
          erros++;
          System.out.println("‚ùå CEP retornou null (inv√°lido ou n√£o encontrado)");
        } else if (response.isErro()) {
          erros++;
          System.out.println("‚ùå CEP n√£o encontrado na base ViaCEP");
        } else {
          sucessos++;
          System.out.println(
              "‚úÖ CEP encontrado: " + response.getLocalidade() + "/" + response.getUf());
        }

      } catch (Exception e) {
        timeouts++;
        System.out.println("‚è±Ô∏è Timeout/Erro de rede: " + e.getMessage());
      }

      // Pausa entre requisi√ß√µes para n√£o sobrecarregar API
      try {
        Thread.sleep(200);
      } catch (InterruptedException ignored) {
      }
    }

    System.out.println("\nüìä RESUMO DOS TESTES:");
    System.out.println("   ‚úÖ Sucessos: " + sucessos);
    System.out.println("   ‚ùå Erros esperados: " + erros);
    System.out.println("   ‚è±Ô∏è Timeouts/Rede: " + timeouts);
    System.out.printf("   üìà Taxa de sucesso: %.1f%%%n", (sucessos * 100.0) / cepsParaTeste.length);

    // Verificar se pelo menos alguns CEPs funcionaram
    assertTrue(
        sucessos > 0 || timeouts > 0,
        "Pelo menos alguns CEPs deveriam funcionar ou dar timeout (indicando tentativa de"
            + " conex√£o)");

    System.out.println("üéâ TESTE DE M√öLTIPLOS CEPS CONCLU√çDO!");
  }

  @Test
  @DisplayName("Deve testar performance e timeouts")
  void deveTestarPerformanceETimeouts() {
    System.out.println("\nüß™ TESTE DE INTEGRA√á√ÉO: Performance e Timeouts");

    String cepTeste = "01001000";
    int numeroTestes = 3;
    long[] tempos = new long[numeroTestes];

    System.out.println("üìä Executando " + numeroTestes + " requisi√ß√µes para medir performance:");

    for (int i = 0; i < numeroTestes; i++) {
      System.out.println("\nüîÑ Requisi√ß√£o " + (i + 1) + "/" + numeroTestes);

      long inicio = System.currentTimeMillis();

      try {
        ViaCepResponseDto response = viaCepService.buscarEnderecoPorCep(cepTeste);
        long fim = System.currentTimeMillis();
        tempos[i] = fim - inicio;

        System.out.println("‚è±Ô∏è Tempo: " + tempos[i] + "ms");

        if (response != null && !response.isErro()) {
          System.out.println("‚úÖ Resposta v√°lida recebida");
        } else {
          System.out.println("‚ö†Ô∏è Resposta com erro ou null");
        }

      } catch (Exception e) {
        long fim = System.currentTimeMillis();
        tempos[i] = fim - inicio;
        System.out.println("‚ùå Erro ap√≥s " + tempos[i] + "ms: " + e.getMessage());
      }

      // Pausa entre requisi√ß√µes
      if (i < numeroTestes - 1) {
        try {
          Thread.sleep(500);
        } catch (InterruptedException ignored) {
        }
      }
    }

    // Calcular estat√≠sticas
    long tempoTotal = 0;
    long tempoMin = Long.MAX_VALUE;
    long tempoMax = 0;

    for (long tempo : tempos) {
      tempoTotal += tempo;
      tempoMin = Math.min(tempoMin, tempo);
      tempoMax = Math.max(tempoMax, tempo);
    }

    double tempoMedio = tempoTotal / (double) numeroTestes;

    System.out.println("\nüìä ESTAT√çSTICAS DE PERFORMANCE:");
    System.out.println("   ‚è±Ô∏è Tempo m√©dio: " + String.format("%.1f", tempoMedio) + "ms");
    System.out.println("   üèÉ Tempo m√≠nimo: " + tempoMin + "ms");
    System.out.println("   üêå Tempo m√°ximo: " + tempoMax + "ms");
    System.out.println("   üìà Varia√ß√£o: " + (tempoMax - tempoMin) + "ms");

    // Verificar se os tempos est√£o dentro dos timeouts configurados
    long timeoutConfigurado = 10000; // 10 segundos (ReadTimeout)

    for (long tempo : tempos) {
      assertTrue(
          tempo <= timeoutConfigurado + 1000, // +1s de margem
          "Tempo de resposta ("
              + tempo
              + "ms) n√£o deveria exceder timeout configurado ("
              + timeoutConfigurado
              + "ms)");
    }

    System.out.println("‚úÖ Todos os tempos dentro do timeout configurado");

    // Verificar performance aceit√°vel (m√©dia < 5 segundos para API externa)
    if (tempoMedio < 5000) {
      System.out.println("üöÄ Performance excelente (< 5s)");
    } else if (tempoMedio < 8000) {
      System.out.println("‚ö° Performance boa (< 8s)");
    } else {
      System.out.println("üêå Performance lenta (> 8s) - pode ser problema de rede");
    }

    System.out.println("üéâ TESTE DE PERFORMANCE CONCLU√çDO!");
  }

  @Test
  @DisplayName("Deve demonstrar uso completo do sistema")
  void deveDemonstrarUsoCompletoDoSistema() {
    System.out.println("\nüß™ DEMONSTRA√á√ÉO: Uso completo do sistema ViaCEP");

    System.out.println("\nüéØ CEN√ÅRIO: Cliente quer cadastrar endere√ßo com CEP");

    // Simula dados de entrada do usu√°rio
    String cepUsuario = "01310-100"; // Av. Paulista, SP
    String numeroUsuario = "1578";
    String complementoUsuario = "Conjunto 142";

    System.out.println("üìã Dados fornecidos pelo usu√°rio:");
    System.out.println("   CEP: " + cepUsuario);
    System.out.println("   N√∫mero: " + numeroUsuario);
    System.out.println("   Complemento: " + complementoUsuario);

    try {
      System.out.println("\nüîç PASSO 1: Validando CEP na base ViaCEP...");

      // Primeira valida√ß√£o - CEP existe?
      boolean cepValido = viaCepService.validarCep(cepUsuario);
      System.out.println("   Resultado valida√ß√£o: " + (cepValido ? "‚úÖ V√°lido" : "‚ùå Inv√°lido"));

      if (cepValido) {
        System.out.println("\nüìç PASSO 2: Buscando dados completos do endere√ßo...");

        // Busca detalhada
        ViaCepResponseDto dadosEndereco = viaCepService.buscarEnderecoPorCep(cepUsuario);

        if (dadosEndereco != null && !dadosEndereco.isErro()) {
          System.out.println("‚úÖ Dados encontrados:");
          System.out.println("   üè¢ Logradouro: " + dadosEndereco.getLogradouro());
          System.out.println("   üèòÔ∏è Bairro: " + dadosEndereco.getBairro());
          System.out.println("   üèôÔ∏è Cidade: " + dadosEndereco.getLocalidade());
          System.out.println("   üó∫Ô∏è Estado: " + dadosEndereco.getUf());
          System.out.println("   üìû DDD: " + dadosEndereco.getDdd());

          System.out.println("\nüèóÔ∏è PASSO 3: Criando entidade Endereco...");

          // Convers√£o para entidade
          Endereco enderecoCompleto =
              viaCepService.buscarEConverterEndereco(cepUsuario, numeroUsuario, complementoUsuario);

          if (enderecoCompleto != null) {
            System.out.println("‚úÖ Entidade criada com sucesso:");
            System.out.println(
                "   üìç Endere√ßo completo: " + enderecoCompleto.getEnderecoCompleto());
            System.out.println("   ‚úÖ Dados completos: " + enderecoCompleto.isCompleto());
            System.out.println(
                "   üì¶ Pronto para persist√™ncia: "
                    + (enderecoCompleto.isCompleto() ? "SIM" : "N√ÉO"));

            System.out.println("\nüíæ PASSO 4: Simulando persist√™ncia...");

            // Aqui normalmente salvaria no banco de dados
            System.out.println("   üîÑ endereco.save() - SIMULADO");
            System.out.println(
                "   ‚úÖ Endere√ßo salvo com ID: "
                    + (enderecoCompleto.getId() != null
                        ? enderecoCompleto.getId()
                        : "AUTO_GENERATED"));

            System.out.println("\nüéâ FLUXO COMPLETO EXECUTADO COM SUCESSO!");
            System.out.println("   ‚úÖ CEP validado");
            System.out.println("   ‚úÖ Dados buscados na API");
            System.out.println("   ‚úÖ Entidade criada");
            System.out.println("   ‚úÖ Pronto para persist√™ncia");

            // Assertions para garantir que tudo funcionou
            assertNotNull(enderecoCompleto);
            assertTrue(enderecoCompleto.isCompleto());
            assertEquals(
                cepUsuario.replaceAll("\\D", "").substring(0, 5)
                    + "-"
                    + cepUsuario.replaceAll("\\D", "").substring(5),
                enderecoCompleto.getCep());
            assertEquals(numeroUsuario, enderecoCompleto.getNumero());

          } else {
            System.out.println("‚ùå Falha na cria√ß√£o da entidade");
            fail("Entidade n√£o deveria ser null para dados v√°lidos");
          }

        } else {
          System.out.println("‚ùå CEP n√£o encontrado na base ViaCEP");
          System.out.println("   üí° Usu√°rio deve informar dados manualmente");
        }

      } else {
        System.out.println("‚ùå CEP inv√°lido - usu√°rio deve corrigir");
        System.out.println("   üí° Mostrar mensagem de erro amig√°vel");
      }

    } catch (Exception e) {
      System.out.println("‚ùå ERRO no fluxo: " + e.getMessage());
      System.out.println("   üí° Sistema deve ter fallback para entrada manual");
      System.out.println("   üîß Log completo:");
      e.printStackTrace();

      // Em um sistema real, isso seria logado e teria fallback
      System.out.println("üü° FALLBACK: Permitir cadastro manual do endere√ßo");
    }

    System.out.println("\nüéâ DEMONSTRA√á√ÉO CONCLU√çDA!");
  }

  @Test
  @DisplayName("Deve testar robustez do sistema")
  void deveTestarRobustezDoSistema() {
    System.out.println("\nüß™ TESTE DE ROBUSTEZ: Cen√°rios extremos e edge cases");

    System.out.println("\nüéØ Testando diferentes tipos de entrada:");

    // Teste de entradas extremas
    String[] entradasExtremas = {
      null,
      "",
      "   ",
      "abc",
      "12345",
      "123456789",
      "00000-000",
      "99999-999",
      "01001000",
      "01001-000",
      "010010001", // 9 d√≠gitos
      "abcde-fgh"
    };

    int testesExecutados = 0;
    int testesComErro = 0;
    int testesComSucesso = 0;
    int testesComTimeout = 0;

    for (String entrada : entradasExtremas) {
      System.out.println("\nüîç Testando entrada: '" + entrada + "'");
      testesExecutados++;

      try {
        long inicio = System.currentTimeMillis();
        ViaCepResponseDto resultado = viaCepService.buscarEnderecoPorCep(entrada);
        long tempo = System.currentTimeMillis() - inicio;

        System.out.println("   ‚è±Ô∏è Tempo: " + tempo + "ms");

        if (resultado == null) {
          testesComErro++;
          System.out.println("   ‚úÖ Retornou null (entrada inv√°lida tratada corretamente)");
        } else if (resultado.isErro()) {
          testesComErro++;
          System.out.println("   ‚úÖ Retornou erro (CEP n√£o encontrado - comportamento esperado)");
        } else {
          testesComSucesso++;
          System.out.println("   ‚úÖ Retornou dados v√°lidos: " + resultado.getLocalidade());
        }

      } catch (Exception e) {
        testesComTimeout++;
        System.out.println(
            "   ‚ö†Ô∏è Exce√ß√£o: " + e.getClass().getSimpleName() + " - " + e.getMessage());
      }
    }

    System.out.println("\nüìä RESUMO DOS TESTES DE ROBUSTEZ:");
    System.out.println("   üß™ Total executados: " + testesExecutados);
    System.out.println("   ‚úÖ Sucessos: " + testesComSucesso);
    System.out.println("   ‚ùå Erros esperados: " + testesComErro);
    System.out.println("   ‚ö†Ô∏è Timeouts/Exce√ß√µes: " + testesComTimeout);

    // O sistema deve ser robusto - n√£o quebrar com entradas inv√°lidas
    assertTrue(
        testesComTimeout == 0 || testesComTimeout < testesExecutados / 2,
        "Sistema n√£o deveria ter muitas exce√ß√µes n√£o tratadas");

    System.out.println("‚úÖ Sistema demonstrou robustez adequada");
    System.out.println("üéâ TESTE DE ROBUSTEZ CONCLU√çDO!");
  }
}
